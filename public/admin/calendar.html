<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - GymBot Admin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #1a1a1a;
            color: white;
            padding: 30px 0;
            position: fixed;
            height: 100vh;
        }

        .logo {
            padding: 0 30px 30px;
            border-bottom: 1px solid #333;
            margin-bottom: 30px;
        }

        .logo h1 {
            font-size: 1.5em;
            color: #667eea;
        }

        .nav-item {
            padding: 15px 30px;
            color: #aaa;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #667eea;
            color: white;
        }

        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 40px;
        }

        .calendar-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        #calendar {
            max-width: 100%;
        }

        .fc {
            font-family: 'Inter', sans-serif;
        }

        .fc-toolbar-title {
            font-size: 1.8em !important;
            font-weight: 700 !important;
        }

        .fc-button {
            background: #667eea !important;
            border: none !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
        }

        .fc-button:hover {
            background: #5568d3 !important;
        }

        .legend {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="logo">
            <h1>ü§ñ GymBot</h1>
        </div>
        <a href="dashboard.html" class="nav-item">üìä Dashboard</a>
        <a href="settings.html" class="nav-item">‚öôÔ∏è Impostazioni</a>
        <a href="courses.html" class="nav-item">üèãÔ∏è Corsi</a>
        <a href="staff.html" class="nav-item">üë• Staff & Trainer</a>
        <a href="pricing.html" class="nav-item">üí∞ Prezzi</a>
        <a href="calendar.html" class="nav-item active">üìÖ Calendario</a>
        <a href="bookings.html" class="nav-item">üìã Prenotazioni</a>
        <a href="chatbot.html" class="nav-item">ü§ñ Chatbot</a>
    </div>

    <div class="main-content">
        <h2 style="margin-bottom: 30px; font-size: 2em;">Calendario Prenotazioni</h2>

        <div class="calendar-container">
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>Confermata</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>In attesa</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>Cancellata</span>
                </div>
            </div>

            <div id="calendar"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/admin/supabase-init.js"></script>
    <script>
        const gymId = localStorage.getItem('gymId');

        async function loadCalendar() {
            const sb = await initSupabase();
            if (!sb) return;

            const { data: bookings } = await sb
                .from('bookings')
                .select('*')
                .eq('gym_id', gymId)
                .order('booking_date', { ascending: true });

            const events = bookings.map(b => ({
                title: `${b.customer_name} - ${b.customer_phone}`,
                start: `${b.booking_date}T${b.booking_time}`,
                end: calculateEndTime(b.booking_date, b.booking_time, b.duration),
                backgroundColor: b.status === 'confirmed' ? '#10b981' :
                    b.status === 'pending' ? '#f59e0b' : '#ef4444',
                borderColor: 'transparent',
                extendedProps: {
                    bookingId: b.id,
                    status: b.status,
                    email: b.customer_email
                }
            }));

            const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                slotMinTime: '06:00:00',
                slotMaxTime: '23:00:00',
                allDaySlot: false,
                nowIndicator: true,
                events: events,
                eventClick: function (info) {
                    const booking = info.event.extendedProps;
                    alert(`Cliente: ${info.event.title}\nEmail: ${booking.email}\nStato: ${booking.status}`);
                },
                height: 'auto',
                locale: 'it'
            });

            calendar.render();

            // Real-time updates
            sb.channel('bookings')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'bookings',
                    filter: `gym_id=eq.${gymId}`
                }, () => {
                    loadCalendar();
                })
                .subscribe();
        }

        function calculateEndTime(date, time, duration) {
            const [hours, minutes] = time.split(':').map(Number);
            const totalMinutes = hours * 60 + minutes + duration;
            const endHours = Math.floor(totalMinutes / 60);
            const endMinutes = totalMinutes % 60;
            return `${date}T${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
        }

        loadCalendar();
    </script>
</body>

</html>